# FamilyApp (Flutter)

Это начальный скелет Android‑приложения **FamilyApp**, разработанного на Flutter.
Данная версия содержит базовую структуру проекта, модели данных (`FamilyMember`,
`Task`, `Event`) и простые экраны для отображения членов семьи, задач и событий.
Позднее будут добавлены механизмы синхронизации, чаты, аудио/видео‑звонки, геопозиционные
уведомления, система поощрений, галерея и прочие возможности, описанные в плане
разработки.

## Запуск

Чтобы запустить приложение:

```bash
cd FamilyAppFlutter
flutter pub get
flutter run
```

Проект расчитан на запуск только на Android.

### Bootstrap и инициализация

- При старте выполняется `bootstrap()`, который инициализирует Firebase, включает оффлайн-персистентность Firestore и подготавливает зашифрованный Hive.
- Ключ шифрования Hive создаётся один раз и хранится в Android Keystore через `flutter_secure_storage`, поэтому его нет в файловой системе или в репозитории.
- Первичный FCM-токен сохраняется в локальном шифрованном боксе, что позволит позже синхронизировать его с профилем участника семьи.
- При первом запуске Android 13+ пользователю будет предложено разрешить уведомления (POST_NOTIFICATIONS).


### Синхронизация данных

- Вся работа с Firestore проходит через репозитории (`lib/repositories/*`) и `SyncService`, которые поддерживают двустороннюю синхронизацию с Hive и Firestore с разрешением конфликтов по полю `updatedAt`.
- Изменения, выполненные оффлайн, накапливаются в зашифрованных боксах, а затем отправляются батчами в Firestore при следующем вызове `SyncService.flush()`.
- Подписки на `snapshots()` Firestore обновляют локальный кеш и автоматически подтягивают новые сообщения чатов, задачи, события, друзей и медиа.


### Аутентификация и профили

- Экран входа (`lib/screens/auth/sign_in_screen.dart`) поддерживает email/пароль и Google Sign-In. При первой регистрации автоматически создаётся документ `families/{familyId}` и профиль участника в `members/` c зашифрованными полями.
- Если Google-аккаунт входит впервые, пользователь перенаправляется на экран завершения профиля для указания имени и названия семьи.
- После успешного входа FCM-токен устройства синхронизируется с профилем участника (поле `fcmTokens`) через `NotificationsService.syncTokenToMember(...)`, чтобы push-уведомления корректно адресовались.
- Раздел «Профиль» доступен из бокового меню и позволяет обновить имя, контактные данные, хобби и аватар. Файлы загружаются в Firebase Storage, а прежние аватары удаляются, чтобы не захламлять хранилище.

### Remote Config

- Значения Remote Config подгружаются при старте (`RemoteConfigService`) и управляют видимостью отдельных модулей (AI-подсказки, звонки). Это позволяет включать/отключать функции без обновления приложения в Google Play.
- Ключ `feature_onboarding_tips` дополнительно управляет Android-баннером быстрых подсказок на домашнем экране; состояние скрытия сохраняется в зашифрованном боксе Hive.
- Ключи: `feature_ai_suggestions`, `feature_webrtc_enabled`, `feature_onboarding_tips`. Значения по умолчанию — `true`.

### Google Sign-In

1. Добавьте SHA-1/ SHA-256 отпечатки debug/release keystore в консоли Firebase.
2. Включите Google Sign-In в разделе Authentication → Sign-in method.
3. Скачайте обновлённый `google-services.json` и замените файл в `android/app/`.
4. Убедитесь, что `com.google.android.gms:play-services-auth` подтягивается transitively (идёт в составе `google_sign_in`).

### Профиль участника

- Данные хранятся в коллекции `families/{familyId}/members/{memberId}` и шифруются через `EncryptedFirestoreService` (AES-GCM, ключ в Android Keystore).
- Поля: `name`, `relationship`, `phone`, `email`, `avatarUrl`, `avatarStoragePath`, `hobbies`, `fcmTokens`, `isAdmin`, временные метки `createdAt/updatedAt`.
- Кнопка «Сохранить изменения» обновляет локальный Hive-кеш и мгновенно пушит изменения в Firestore (через `FamilyData.updateMember` + `SyncService.flush()`).


## Firebase конфигурация для Android

1. Получите файл `google-services.json` в консоли Firebase для приложения с пакетом `com.familyapp.android`.
2. Поместите файл в каталог `android/app/`, заменив placeholder-версию из репозитория.
3. Убедитесь, что значения `project_id`, `project_number` и `api_key` соответствуют вашему проекту.
4. В консоли Firebase включите Cloud Messaging, чтобы приложение получало и отображало уведомления через локальный канал `familyapp_default`.


### Firestore индексы

Для корректной загрузки истории сообщений и звонков необходимо создать композитные индексы в консоли Firebase:

1. **Коллекционный индекс для чатов** — коллекция `messages` (collection group), поля `chatId` по возрастанию и `createdAt` по убыванию.
2. **Коллекционный индекс для звонков** — collection group `messages`, поля `conversationId` по возрастанию и `createdAt` по убыванию.

Эти индексы позволяют выборку сообщений по участникам с сортировкой по времени создания и требуются для работы realtime-чатов и сигнального канала WebRTC.


## Структура

- `lib/main.dart` – точка входа приложения и навигация по основным экранам.
- `lib/models/` – простые модели данных.
- `lib/screens/` – экраны аутентификации, домашний хаб и разделы семьи/задач/событий.
- `pubspec.yaml` – описание зависимостей проекта.
На текущем этапе приложение работает только на Android и требует реального проекта Firebase для авторизации, синхронизации и уведомлений.
